<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Barber√≠a C√©sar - Reserva tu cita</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(145deg, #0f0f0f, #1a1a1a);
      color: #f5f5f5;
      margin: 0;
      padding: 0;
      background-attachment: fixed;
    }
    .header {
      background: #1c1c1c;
      padding: 20px;
      text-align: center;
      font-size: 26px;
      font-weight: bold;
      color: #f2c94c;
      box-shadow: 0 2px 8px rgba(0,0,0,0.6);
      border-bottom: 3px solid #f2c94c;
    }
    .chatbox {
      width: 95%;
      max-width: 420px;
      margin: 30px auto;
      background: #1a1a1a;
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(0,0,0,0.7);
      padding: 20px;
      border: 1px solid #333;
    }
    .messages {
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 10px;
    }
    .message {
      margin: 12px 0;
      padding: 10px;
      border-radius: 8px;
      max-width: 90%;
      word-wrap: break-word;
      animation: fadeIn 0.5s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .bot {
      background: #2d2d2d;
      color: #f2c94c;
    }
    .user {
      background: #4aa3ff;
      color: #fff;
      text-align: right;
      margin-left: auto;
    }
    input[type="text"] {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      background: #2c2c2c;
      color: #fff;
      margin-top: 10px;
    }
    .panel-admin {
      width: 95%;
      max-width: 420px;
      margin: 20px auto;
      background: #1e1e1e;
      border: 1px solid #444;
      border-radius: 12px;
      padding: 15px;
      display: none;
    }
    .panel-admin button {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
      background: #f2c94c;
      color: #000;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="header">Barber√≠a C√©sar ‚úÇ Reserva tu cita</div>
  <div class="chatbox">
    <div class="messages" id="messages"></div>
    <input type="text" id="userInput" placeholder="Escribe tu respuesta..." autocomplete="off" />
  </div>
  <div class="panel-admin" id="panelAdmin">
    <h3>Panel de Administraci√≥n</h3>
    <button onclick="descargarCSV()">Descargar reservas (CSV)</button>
  </div>

  <script>
    const messages = document.getElementById('messages');
    const userInput = document.getElementById('userInput');
    const panelAdmin = document.getElementById('panelAdmin');

    let step = 0;
    let reserva = { nombre: "", fecha: "", hora: "", personas: "" };

    const botMessages = [
      "¬°Hola! Bienvenido a *Barber√≠a C√©sar* ‚úÇ ¬øC√≥mo te llamas?",
      "¬øPara qu√© fecha deseas la cita? (Ej: 25/05)",
      "¬øA qu√© hora prefieres venir? (No disponible entre 14:00 y 17:00)",
      "¬øCu√°ntas personas asistir√°n?",
      "¬°Perfecto! Aqu√≠ tienes tu cita confirmada:",
      "¬°Gracias por reservar! Te esperamos con estilo üíà"
    ];

    function addMessage(text, sender) {
      const div = document.createElement("div");
      div.classList.add("message", sender);
      div.innerText = text;
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
    }

    function enviarReservaAGoogleSheets() {
      const url = "https://script.google.com/macros/s/AKfycbz5fvqbYOiLa-tTDm0fMMIajPrt9Aj8B0RR7qW4kVOqazpQGALwqgHUfydXH9hs3BrU/exec";
      fetch(url, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(reserva)
      });
    }

    function descargarCSV() {
      const csvData = localStorage.getItem("reservas_csv");
      if (!csvData) return alert("No hay datos guardados a√∫n.");
      const blob = new Blob([csvData], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.setAttribute("download", "reservas_barberia.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function botNextMessage() {
      setTimeout(() => {
        if (step < botMessages.length - 2) {
          addMessage(botMessages[step], "bot");
        } else if (step === botMessages.length - 2) {
          const resumen = `üìã Nombre: ${reserva.nombre}\nüìÖ Fecha: ${reserva.fecha}\nüïí Hora: ${reserva.hora}\nüë• Personas: ${reserva.personas}`;
          addMessage(botMessages[step], "bot");
          addMessage(resumen, "bot");
          enviarReservaAGoogleSheets();
          guardarEnLocalStorage();
        } else {
          addMessage(botMessages[step], "bot");
        }
      }, 1000);
    }

    function guardarEnLocalStorage() {
      const encabezado = ["Nombre", "Fecha", "Hora", "Personas"];
      const fila = [reserva.nombre, reserva.fecha, reserva.hora, reserva.personas].join(",");
      let csv = localStorage.getItem("reservas_csv");
      if (!csv) {
        csv = encabezado.join(",") + "\n";
      }
      csv += fila + "\n";
      localStorage.setItem("reservas_csv", csv);
    }

    userInput.addEventListener("keypress", function(e) {
      if (e.key === "Enter" && userInput.value.trim() !== "") {
        const input = userInput.value.trim();

        if (input === "admin123") {
          panelAdmin.style.display = "block";
          addMessage("[Panel administrativo habilitado]", "bot");
          userInput.value = "";
          return;
        }

        if (step === 2) {
          const hora = parseInt(input.split(":"[0]));
          if (hora >= 14 && hora < 17) {
            addMessage("Lo sentimos, no se aceptan reservas entre las 14:00 y las 17:00. Por favor elige otra hora.", "bot");
            return;
          }
        }

        addMessage(input, "user");

        if (step === 0) reserva.nombre = input;
        else if (step === 1) reserva.fecha = input;
        else if (step === 2) reserva.hora = input;
        else if (step === 3) reserva.personas = input;

        step++;
        userInput.value = "";
        botNextMessage();
      }
    });

    botNextMessage();
  </script>
</body>
</html>
